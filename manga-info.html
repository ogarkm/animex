<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Manga Info - Loading...</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" href="Resources/manga.css?v=1.2" />
  </head>
  <body>
    <div id="manga-container">
      <header id="hero-section">
        <div class="hero-overlay"></div>
        <h1 id="vertical-title-jp" class="vertical-title-jp">読込中</h1>
        <div class="cover-art-container">
          <img
            id="manga-cover"
            src="https://placehold.co/400x600/141414/333?text=?"
            alt="Manga Cover Art"
          />
        </div>
      </header>

      <main id="content-sheet">
        <div class="add-list-btn-container">
          <button
            id="add-series-to-list-btn"
            class="hero-action-btn"
            title="Add Series to List"
          >
            <i class="fa-solid fa-book-bookmark"></i>  Add to List
          </button>
        </div>
        <h2 id="manga-title-en" class="manga-title-en">Loading Title...</h2>
        <p id="manga-title-jp" class="manga-title-jp">読込中...</p>

        <div id="info-tags-container" class="genres-container"></div>

        <div class="synopsis-container">
          <h3>Synopsis</h3>
          <p id="manga-synopsis">Loading synopsis...</p>
        </div>

        <button
          id="jump-to-last-read-btn"
          class="jump-read-btn"
          style="display: none; margin-bottom: 1rem; width: 100%"
        >
          <i class="fa-solid fa-book-open"></i> Continue Reading
        </button>

        <div class="tabs-section">
          <div class="tabs-container">
            <button class="tab-btn active" data-tab="chapters">Chapters</button>
            <button class="tab-btn" data-tab="related">Related</button>
            <button class="tab-btn" data-tab="recommendations">
              Recommendations
            </button>
          </div>
          <div class="tab-content-container">
            <div id="tab-panel-chapters" class="tab-panel active">
              <button id="clear-cache-btn" class="clear-cache-btn">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
              <div
                id="pagination-container-top"
                class="pagination-container"
              ></div>
              <div id="chapters-loader" class="loader"></div>
              <ul id="chapter-list"></ul>
              <div id="pagination-container" class="pagination-container"></div>
            </div>
            <div id="tab-panel-related" class="tab-panel">
              <div
                class="related-content-container"
                id="related-content-container"
              >
                <!-- Related content will be generated by JS -->
              </div>
            </div>
            <div id="tab-panel-recommendations" class="tab-panel">
              <div class="content-grid" id="recommendations-grid">
                <!-- Recommendation cards will be generated by JS -->
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Reader Modal container, controlled by JS -->
    <div id="reader-modal-container"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const heroSection = document.getElementById("hero-section");
        const verticalTitleJp = document.getElementById("vertical-title-jp");
        const mangaCover = document.getElementById("manga-cover");
        const coverArtContainer = document.querySelector(
          ".cover-art-container"
        );
        const mangaTitleEn = document.getElementById("manga-title-en");
        const mangaTitleJp = document.getElementById("manga-title-jp");
        const infoTagsContainer = document.getElementById(
          "info-tags-container"
        );
        const mangaSynopsis = document.getElementById("manga-synopsis");
        const chapterList = document.getElementById("chapter-list");
        const chaptersLoader = document.getElementById("chapters-loader");
        const tabsContainer = document.querySelector(".tabs-container");
        const tabPanels = document.querySelectorAll(".tab-panel");
        const readerModal = document.getElementById("reader-modal-container");
        const relatedContainer = document.getElementById(
          "related-content-container"
        );
        const recommendationsContainer = document.getElementById(
          "recommendations-grid"
        );
        const jumpToLastReadBtn = document.getElementById(
          "jump-to-last-read-btn"
        );
        // NEW: Add to List button selector
        const addSeriesToListBtn = document.getElementById(
          "add-series-to-list-btn"
        );

        const serverUrl = `http://${
          localStorage.getItem("extension_server_ip") || "localhost"
        }:7275`;
        let currentMangaId = null;
        let currentMangaTitle = ""; // NEW: state for manga title
        let currentSource = "jikan"; // Default source
        let mangadexCurrentPage = 1;
        const mangadexChaptersPerPage = 50;
        let mangadexTotalChapters = 0;

        function getUrlParams() {
          const params = new URLSearchParams(window.location.search);
          currentSource = params.get("source") || "jikan";
          currentMangaId = params.get("id");
          return { source: currentSource, id: currentMangaId };
        }

        // --- Jikan API Fetchers ---
        async function fetchJikanMangaDetails(mangaId) {
          const response = await fetch(
            `https://api.jikan.moe/v4/manga/${mangaId}/full`
          );
          if (!response.ok)
            throw new Error(`Jikan API error: ${response.status}`);
          const data = (await response.json()).data;
          // Normalize data for display function
          return {
            title: data.title,
            title_japanese: data.title_japanese,
            image_url:
              data.images?.jpg?.large_image_url || data.images?.jpg?.image_url,
            synopsis: data.synopsis,
            genres: [...data.genres, ...data.themes, ...data.demographics].map(
              (g) => g.name
            ),
          };
        }

        async function fetchJikanMangaChapters(mangaId) {
          const response = await fetch(`${serverUrl}/chapters/${mangaId}`);
          if (!response.ok)
            throw new Error(
              `Server chapter endpoint error: ${response.status}`
            );
          const data = (await response.json()).chapters;
          // Normalize
          return data
            .map((ch) => ({
              id: ch.chapter_number, // Use chapter number as ID for Jikan
              title: ch.title,
              chapter_number: ch.chapter_number,
            }))
            .reverse();
        }

        // --- MangaDex API Fetchers ---
        async function fetchMangaDexDetails(mangaId) {
          const response = await fetch(
            `${serverUrl}/mangadex/manga/${mangaId}`
          );
          if (!response.ok)
            throw new Error(`MangaDex API error: ${response.status}`);
          const data = await response.json();

          // Normalize data structure to match what the display function expects
          const title =
            data.attributes.title.en || Object.values(data.attributes.title)[0];
          currentMangaTitle = title; // NEW: Store title
          return {
            title: title,
            title_japanese:
              data.attributes.altTitles.find((t) => t.ja)?.ja || "",
            image_url:
              data.image_url ||
              "https://placehold.co/400x600/141414/333?text=?", // Use pre-processed URL from backend
            synopsis:
              data.attributes.description.en || "No synopsis available.",
            genres: data.attributes.tags
              .filter((t) => t.group === "genre" || t.group === "theme")
              .map((t) => t.attributes.name.en),
          };
        }

        async function fetchMangaDexChapters(mangaId, page = 1) {
          const limit = mangadexChaptersPerPage;
          const offset = (page - 1) * limit;
          const response = await fetch(
            `${serverUrl}/mangadex/manga/${mangaId}/chapters?limit=${limit}&offset=${offset}`
          );
          if (!response.ok)
            throw new Error(`MangaDex chapters error: ${response.status}`);
          const data = await response.json();

          mangadexTotalChapters = data.total;
          mangadexCurrentPage = page;

          // Normalize
          return data.chapters.map((ch) => {
            const scanlationGroup = ch.relationships.find(
              (rel) => rel.type === "scanlation_group"
            );
            const groupName = scanlationGroup
              ? scanlationGroup.attributes.name
              : "N/A";
            return {
              id: ch.id, // Use MangaDex's UUID as the unique ID
              title: ch.attributes.title || `Chapter ${ch.attributes.chapter}`,
              chapter_number: ch.attributes.chapter,
              scanlation_group_name: groupName,
              pages: ch.attributes.pages,
              publishAt: ch.attributes.publishAt,
            };
          });
        }

        // NEW: Fetch all chapter IDs for MangaDex
        async function fetchAllMangaDexChapterIds(mangaId) {
          const response = await fetch(
            `${serverUrl}/mangadex/manga/${mangaId}/all-chapters`
          );
          if (!response.ok)
            throw new Error(`Fetch all chapters error: ${response.status}`);
          const data = await response.json();
          return data.chapter_ids || [];
        }

        function displayMangaInfo(data) {
          if (!data) {
            document.body.innerHTML = `<p class="placeholder-text" style="padding-top: 5rem;">Could not load manga details. Please check the ID and try again.</p>`;
            return;
          }
          currentMangaTitle = data.title; // NEW: Store title
          document.title = `${data.title} - Manga Info`;
          heroSection.style.backgroundImage = `url('${data.image_url}?size=512')`;
          mangaCover.src = data.image_url;
          mangaCover.alt = `${data.title} Cover Art`;
          verticalTitleJp.textContent = (data.title_japanese || "").slice(
            0,
            10
          );
          mangaTitleEn.textContent = data.title;
          mangaTitleJp.textContent = data.title_japanese || "";
          mangaSynopsis.textContent = data.synopsis || "No synopsis available.";
          infoTagsContainer.innerHTML = "";
          (data.genres || []).slice(0, 4).forEach((g) => {
            const tag = document.createElement("span");
            tag.className = "genre-tag";
            tag.textContent = g;
            infoTagsContainer.appendChild(tag);
          });
          setTimeout(() => {
            verticalTitleJp.classList.add("loaded");
            coverArtContainer.classList.add("loaded");
          }, 100);
        }

        function displayChapters(chapters) {
          chaptersLoader.style.display = "none";
          chapterList.innerHTML = "";
          if (!chapters || chapters.length === 0) {
            chapterList.innerHTML = `<li class="placeholder-text">No chapters found for this series.</li>`;
            return;
          }

          const readingHistory =
            JSON.parse(localStorage.getItem("reading_history")) || [];

          chapters.forEach((chapter) => {
            const li = document.createElement("li");
            li.className = "chapter-item";

            const historyId =
              currentSource === "jikan"
                ? `${currentMangaId}/${chapter.id}` // chapter.id is the number for Jikan
                : `mangadex:${currentMangaId}/${chapter.id}`; // chapter.id is the UUID for MangaDex

            if (readingHistory.includes(historyId)) {
              li.classList.add("is-read");
            }

            if (currentSource === "mangadex") {
              const publishDate = new Date(
                chapter.publishAt
              ).toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              });
              li.innerHTML = `
                    <div class="chapter-thumbnail">
                        <span class="chapter-number-display">#${
                          chapter.chapter_number || "?"
                        }</span>
                        <div class="read-progress"></div>
                    </div>
                    <div class="chapter-details">
                        <span class="chapter-title">${
                          chapter.title
                            ? `Ch. ${chapter.chapter_number} - ${chapter.title}`
                            : `Chapter ${chapter.chapter_number}`
                        }</span>
                        <div class="chapter-meta-mangadex">
                            <span class="meta-tag chapter-scanlator"><i class="fas fa-users"></i> ${
                              chapter.scanlation_group_name
                            }</span>
                            <span class="meta-tag chapter-pages"><i class="fas fa-book-open"></i> ${
                              chapter.pages
                            } pages</span>
                            <span class="meta-tag chapter-date"><i class="fas fa-calendar-alt"></i> ${publishDate}</span>
                        </div>
                    </div>
                    <div class="chapter-actions">
                        <button class="action-btn add-to-list-btn" title="Add to List">
                            <i class="fas fa-plus-square"></i>
                        </button>
                        <button class="action-btn download-btn" title="Download Chapter">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
            } else {
              // Jikan
              li.innerHTML = `
                    <div class="chapter-thumbnail">
                        <span class="chapter-number-display">#${
                          chapter.chapter_number || "?"
                        }</span>
                        <div class="read-progress"></div>
                    </div>
                    <div class="chapter-details">
                        <span class="chapter-title">${chapter.title}</span>
                        <span class="chapter-meta">Chapter ${
                          chapter.chapter_number || "N/A"
                        }</span>
                    </div>
                    <div class="chapter-actions">
                         <button class="action-btn add-to-list-btn" title="Add to List">
                            <i class="fas fa-plus-square"></i>
                        </button>
                        <button class="action-btn download-btn" title="Download Chapter">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
            }

            li.onclick = () => {
              localStorage.setItem(
                `last_read_${currentMangaId}`,
                JSON.stringify({ source: currentSource, chapterId: chapter.id })
              );
              openReaderModal(
                `/read/${currentSource}/${currentMangaId}/${chapter.id}`
              );
            };

            li.querySelector(".download-btn").onclick = (e) => {
              e.stopPropagation(); // Prevent li click event
              window.open(
                `/download-manga/site/${currentSource}/${currentMangaId}/${chapter.id}`,
                "_blank"
              );
            };

            // NEW: Add to list event listener for chapter item
            li.querySelector(".add-to-list-btn").onclick = (e) => {
              e.stopPropagation();
              if (
                window.parent &&
                typeof window.parent.openListManager === "function"
              ) {
                window.parent.openListManager({
                  type: "manga",
                  id: currentMangaId,
                  title: currentMangaTitle,
                  items: [String(chapter.id)],
                  source: currentSource,
                });
              }
            };

            chapterList.appendChild(li);
          });
        }

        function displayPagination() {
          const paginationContainers = document.querySelectorAll(
            ".pagination-container"
          );
          paginationContainers.forEach((c) => (c.innerHTML = ""));

          if (
            currentSource !== "mangadex" ||
            mangadexTotalChapters <= mangadexChaptersPerPage
          ) {
            return;
          }

          const totalPages = Math.ceil(
            mangadexTotalChapters / mangadexChaptersPerPage
          );
          if (totalPages <= 1) return;

          paginationContainers.forEach((container) => {
            const prevButton = document.createElement("button");
            prevButton.innerHTML = "&laquo; Prev";
            prevButton.disabled = mangadexCurrentPage === 1;
            prevButton.addEventListener("click", () => {
              if (mangadexCurrentPage > 1) {
                loadMangaDexChapterPage(mangadexCurrentPage - 1);
              }
            });
            container.appendChild(prevButton);

            const pageInfo = document.createElement("span");
            pageInfo.textContent = `Page ${mangadexCurrentPage} of ${totalPages}`;
            container.appendChild(pageInfo);

            const nextButton = document.createElement("button");
            nextButton.innerHTML = "Next &raquo;";
            nextButton.disabled = mangadexCurrentPage === totalPages;
            nextButton.addEventListener("click", () => {
              if (mangadexCurrentPage < totalPages) {
                loadMangaDexChapterPage(mangadexCurrentPage + 1);
              }
            });
            container.appendChild(nextButton);
          });
        }

        async function loadMangaDexChapterPage(page) {
          chaptersLoader.style.display = "block";
          chapterList.innerHTML = "";
          document
            .querySelectorAll(".pagination-container")
            .forEach((c) => (c.innerHTML = ""));

          try {
            const chapters = await fetchMangaDexChapters(currentMangaId, page);
            displayChapters(chapters);
            displayPagination();
          } catch (error) {
            console.error(`Failed to load page ${page}:`, error);
            chapterList.innerHTML = `<li class="placeholder-text">Error loading chapters. ${error.message}</li>`;
          } finally {
            chaptersLoader.style.display = "none";
          }
        }

        // --- These functions need to be adapted or disabled for MangaDex ---
        function displayRelations(relations) {
          relatedContainer.innerHTML = "";
          if (
            currentSource !== "jikan" ||
            !relations ||
            relations.length === 0
          ) {
            relatedContainer.innerHTML =
              '<p class="info-message">Related content is only available for the Jikan source.</p>';
            return;
          }
          // This function is Jikan-specific.
        }

        function displayRecommendations(recommendations) {
          recommendationsContainer.innerHTML = "";
          if (
            currentSource !== "jikan" ||
            !recommendations ||
            recommendations.length === 0
          ) {
            recommendationsContainer.innerHTML =
              '<p class="info-message">Recommendations are only available for the Jikan source.</p>';
            return;
          }
          // This function is Jikan-specific.
        }

        function openReaderModal(url) {
          readerModal.innerHTML = `<iframe src="${url}" allowfullscreen></iframe>`;
          readerModal.classList.add("visible");
          document.body.style.overflow = "hidden";
        }

        function closeReaderModal() {
          readerModal.classList.remove("visible");
          document.body.style.overflow = "auto";
          setTimeout(() => {
            readerModal.innerHTML = "";
          }, 400);
        }

        function setupTabs() {
          tabsContainer.addEventListener("click", (e) => {
            const targetTab = e.target.closest(".tab-btn");
            if (!targetTab) return;
            tabsContainer
              .querySelectorAll(".tab-btn")
              .forEach((btn) => btn.classList.remove("active"));
            tabPanels.forEach((panel) => panel.classList.remove("active"));
            targetTab.classList.add("active");
            document
              .getElementById(`tab-panel-${targetTab.dataset.tab}`)
              .classList.add("active");
          });

          if (currentSource === "mangadex") {
            document.querySelector('[data-tab="related"]').style.display =
              "none";
            document.querySelector(
              '[data-tab="recommendations"]'
            ).style.display = "none";
          }
        }

        function setupModalListener() {
          window.addEventListener("message", (event) => {
            if (event.data === "close-reader-modal") {
              closeReaderModal();
            }
          });
        }

        function setupJumpToLastRead() {
          const lastReadData = localStorage.getItem(
            `last_read_${currentMangaId}`
          );
          if (lastReadData) {
            try {
              const { source, chapterId } = JSON.parse(lastReadData);
              if (source === currentSource) {
                jumpToLastReadBtn.style.display = "block";
                jumpToLastReadBtn.onclick = () => {
                  openReaderModal(
                    `/read/${source}/${currentMangaId}/${chapterId}`
                  );
                };
              }
            } catch (e) {
              console.error("Could not parse last read data:", e);
              localStorage.removeItem(`last_read_${currentMangaId}`);
            }
          }
        }

        // NEW: Add to list listener for hero button
        addSeriesToListBtn.addEventListener("click", async () => {
          if (
            !currentMangaId ||
            !window.parent ||
            typeof window.parent.openListManager !== "function"
          )
            return;

          addSeriesToListBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i>'; // Show loading state
          try {
            let allItemIds = [];
            if (currentSource === "mangadex") {
              allItemIds = await fetchAllMangaDexChapterIds(currentMangaId);
            } else {
              // jikan
              const chapters = await fetchJikanMangaChapters(currentMangaId);
              allItemIds = chapters.map((ch) => String(ch.id));
            }

            if (allItemIds.length > 0) {
              window.parent.openListManager({
                type: "manga",
                id: currentMangaId,
                title: currentMangaTitle,
                items: allItemIds,
                source: currentSource,
              });
            } else {
              window.parent.showToast("No chapters found to add.");
            }
          } catch (error) {
            console.error("Failed to get all chapters for list:", error);
            window.parent.showToast("Could not fetch all chapters to add to the list.");
          } finally {
            addSeriesToListBtn.innerHTML = '<i class="fas fa-plus-square"></i>'; // Restore button icon
          }
        });

        async function init() {
          const params = getUrlParams();
          if (!params.id) {
            document.body.innerHTML = `<p class="placeholder-text" style="padding-top: 5rem;">No Manga ID specified in URL.</p>`;
            return;
          }

          setupTabs();
          setupModalListener();
          setupJumpToLastRead();
          document
            .getElementById("clear-cache-btn")
            .addEventListener("click", () => {
              localStorage.removeItem(`chapters_data`); // This might need source-specific keys
              location.reload();
            });

          try {
            if (params.source === "mangadex") {
              const mangaDetails = await fetchMangaDexDetails(params.id);
              displayMangaInfo(mangaDetails);
              await loadMangaDexChapterPage(1);
              displayRelations([]); // Disable for MangaDex
              displayRecommendations([]); // Disable for MangaDex
            } else {
              // Default to Jikan
              const [mangaDetails, chapters] = await Promise.all([
                fetchJikanMangaDetails(params.id),
                fetchJikanMangaChapters(params.id),
              ]);
              displayMangaInfo(mangaDetails);
              displayChapters(chapters);
              // Jikan-specific fetches can remain if needed
              // fetchRelations, fetchRecommendations...
            }
          } catch (error) {
            console.error("Failed to initialize manga page:", error);
            document.body.innerHTML = `<p class="placeholder-text" style="padding-top: 5rem;">Error loading manga details. ${error.message}</p>`;
          }
        }

        init();
      });
    </script>
  </body>
</html>
