<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta 
    name="viewport" 
    content="width=device-width, initial-scale=1.0, user-scalable=no"
  />
  <title>Episode Player</title>

  <!-- Inter font + Font Awesome for icons (if needed) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link 
    rel="preconnect" 
    href="https://fonts.gstatic.com" 
    crossorigin
  />
  <link 
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" 
    rel="stylesheet"
  />
  <style>
    :root {
      --accent-color-active: #FF9500;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #000;
      font-family: 'Inter', sans-serif;
      color: #fff;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
    }
    #player-container {
      flex: 1 1 auto;
      width: 100vw;
      max-width: 100vw;
      min-height: 220px;
      max-height: 60vh;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 2px 16px 0 #000a;
      border-bottom: 1px solid #222;
    }
    #player-container iframe {
      width: 100vw;
      height: 56vw;
      max-height: 60vh;
      min-height: 220px;
      border: none;
      border-radius: 10px;
      background: #111;
      display: block;
    }
    #info-container {
      width: 100vw;
      background: rgba(0,0,0,0.92);
      padding: 1.1rem 1.2rem 1.5rem 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
      font-size: 1.05rem;
      box-sizing: border-box;
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
      box-shadow: 0 -2px 16px 0 #000a;
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10;
    }
    #series-title {
      font-size: 1.15rem;
      font-weight: 700;
      margin-bottom: 0.1rem;
      letter-spacing: 0.01em;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }
    #meta-line {
      font-size: 0.98rem;
      opacity: 0.85;
      display: flex;
      flex-wrap: wrap;
      gap: 0.7em;
    }
    #error-message {
      color: #ff6b6b;
      text-align: center;
      padding: 2rem 1rem;
      font-size: 1.1rem;
    }
    .search-options-list {
      display: flex;
      gap: 18px;
      margin: 10px 0 0 0;
      padding: 0 2px;
      list-style: none;
      justify-content: center;
    }
    .search-option-btn {
      background: none;
      border: none;
      color: #aaa;
      font-size: 1.05em;
      font-weight: 700;
      padding: 10px 28px;
      border-radius: 22px;
      cursor: pointer;
      transition: background 0.18s, color 0.18s;
      outline: none;
      letter-spacing: 0.04em;
      box-shadow: 0 1px 4px 0 #0003;
      touch-action: manipulation;
    }
    .search-option-btn.active {
      background: var(--accent-color-active, #FF9500);
      color: #fff;
    }
    #next-episode-btn {
      margin: 18px auto 0 auto !important;
      display: block;
      background: var(--accent-color-active, #FF9500);
      color: #fff;
      font-weight: 700;
      font-size: 1.08em;
      border: none;
      border-radius: 22px;
      padding: 12px 38px;
      cursor: pointer;
      box-shadow: 0 2px 8px 0 #0002;
      letter-spacing: 0.03em;
      transition: background 0.18s;
    }
    #series-over-msg {
      margin: 18px auto 0 auto !important;
      text-align: center;
      font-weight: 700;
      font-size: 1.08em;
      color: var(--accent-color-active, #FF9500);
    }
    @media (max-width: 600px) {
      #player-container iframe {
        min-height: 180px;
        height: 56vw;
      }
      #info-container {
        font-size: 1.01rem;
        padding: 0.9rem 0.7rem 1.2rem 0.7rem;
      }
      .search-option-btn {
        padding: 9px 18px;
        font-size: 1em;
      }
      #next-episode-btn {
        padding: 10px 22px;
        font-size: 1em;
      }
    }
  </style>
</head>
<body>
  <!-- Video Player -->
  <div id="player-container">
    <!-- JS will inject the <iframe> here -->
  </div>
  <!-- Info and Controls -->
  <div id="info-container">
    <div id="series-title">
      <span id="series-name">—</span>
    </div>
    <div id="meta-line">
      <span>Type: <span id="series-type">—</span></span>
      <span>|</span>
      <span>Year: <span id="series-year">—</span></span>
      <span>|</span>
      <span>Episode: <span id="episode-number">—</span></span>
    </div>
    <ul class="search-options-list" id="search-options-list">
      <li>
        <button class="search-option-btn active" id="sub-option-btn" type="button">
          SUB
        </button>
      </li>
      <li>
        <button class="search-option-btn" id="dub-option-btn" type="button">
          DUB
        </button>
      </li>
    </ul>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
  const params = new URLSearchParams(window.location.search);
  const jikanId = params.get('id');
  const episode = params.get('ep');
  const subOptionBtn = document.getElementById('sub-option-btn');
  const dubOptionBtn = document.getElementById('dub-option-btn');

  if (!jikanId || !episode) {
    document.getElementById('player-container').innerHTML = `
      <div id="error-message">
        Missing “id” or “ep” parameter in URL.<br>
        Example: view.html?id=21&ep=104
      </div>`;
    return;
  }

  // Get preference from localStorage or default to 'sub'
  let userPref = localStorage.getItem('animeDubPref');
  if (!userPref || (userPref !== 'sub' && userPref !== 'dub')) {
    userPref = 'sub';
    localStorage.setItem('animeDubPref', 'sub');
  }

  // Fetch anime info
  let title = 'Unknown';
  let type = 'N/A';
  let year = 'N/A';
  try {
    const resp = await fetch(`https://api.jikan.moe/v4/anime/${jikanId}`);
    if (resp.ok) {
      const data = await resp.json();
      const anime = data.data || {};
      title = anime.title_english || anime.title || 'Unknown';
      type = anime.type || 'N/A';
      year = anime.year || anime.aired?.prop?.from?.year || 'N/A';
    }
  } catch (err) {
    console.warn('Failed to fetch Jikan info:', err);
  }

  document.getElementById('series-name').textContent = title;
  document.getElementById('series-type').textContent = type;
  document.getElementById('series-year').textContent = year;
  document.getElementById('episode-number').textContent = episode;

  // Fetch total episodes
  let totalEpisodes = null;
  try {
    const resp = await fetch(`https://api.jikan.moe/v4/anime/${jikanId}`);
    if (resp.ok) {
      const data = await resp.json();
      totalEpisodes = data.data?.episodes || null;
    }
  } catch (err) {}

  const infoContainer = document.getElementById('info-container');
  let nextEpBtn = document.getElementById('next-episode-btn');
  let seriesOverMsg = document.getElementById('series-over-msg');
  if (nextEpBtn) nextEpBtn.remove();
  if (seriesOverMsg) seriesOverMsg.remove();

  const currentEpNum = parseInt(episode, 10);
  if (totalEpisodes && currentEpNum < totalEpisodes) {
    nextEpBtn = document.createElement('button');
    nextEpBtn.id = 'next-episode-btn';
    nextEpBtn.textContent = `Next Episode →`;
    nextEpBtn.addEventListener('click', () => {
      const params = new URLSearchParams(window.location.search);
      params.set('ep', currentEpNum + 1);
      window.location.search = params.toString();
    });
    infoContainer.appendChild(nextEpBtn);
  } else if (totalEpisodes && currentEpNum >= totalEpisodes) {
    seriesOverMsg = document.createElement('div');
    seriesOverMsg.id = 'series-over-msg';
    seriesOverMsg.textContent = 'Wow... The Series is over';
    infoContainer.appendChild(seriesOverMsg);
  }

  async function loadIframe(dub) {
    const playerContainer = document.getElementById('player-container');
    playerContainer.innerHTML = '';
    const proxyBase = 'https://arkm20-animex-player-api.hf.space';
    const iframeSrcURL = `${proxyBase}/iframe-src?id=${encodeURIComponent(jikanId)}&episode=${encodeURIComponent(episode)}&dub=${dub}`;
    let embedSrc = null;
    try {
      const res = await fetch(iframeSrcURL);
      if (res.ok) {
        const json = await res.json();
        embedSrc = json.src;
      } else {
        console.warn('Proxy returned HTTP', res.status);
      }
    } catch (err) {
      console.error('Error calling proxy:', err);
    }
    if (!embedSrc) {
      playerContainer.innerHTML = `
        <div id="error-message">
          Could not load player. Please try again later.
        </div>`;
      return;
    }
    const iframe = document.createElement('iframe');
    iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');
    iframe.setAttribute('src', embedSrc);
    iframe.setAttribute('allowfullscreen', 'true');
    iframe.setAttribute('scrolling', 'no');
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    playerContainer.appendChild(iframe);
  }

  async function updateWatchHistory(showId, showTitle, episodeNumber) {
    const token = localStorage.getItem('accessToken');
    if (!token) {
      console.log("User not logged in. Skipping watch history update.");
      return;
    }
    try {
      const params = new URLSearchParams({
        show_id: String(showId),
        show_title: String(showTitle),
        season_number: 1,
        episode_number: Number(episodeNumber)
      });
      const url = `https://arkm20-authapi.hf.space/users/me/watch-history?${params.toString()}`;
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      if (response.ok) {
        console.log("Watch history updated successfully.");
      } else {
        const result = await response.json().catch(() => ({}));
        console.warn("Failed to update watch history:", result.message || response.status);
      }
    } catch (error) {
      console.error("Network error while updating watch history:", error);
    }
  }

  // Set active button style and load correct iframe
  if (userPref === 'dub') {
    dubOptionBtn.classList.add('active');
    subOptionBtn.classList.remove('active');
    await loadIframe(true);
  } else {
    subOptionBtn.classList.add('active');
    dubOptionBtn.classList.remove('active');
    await loadIframe(false);
  }

  updateWatchHistory(jikanId, title, episode);

  subOptionBtn.addEventListener('click', async () => {
    if (!subOptionBtn.classList.contains('active')) {
      subOptionBtn.classList.add('active');
      dubOptionBtn.classList.remove('active');
      localStorage.setItem('animeDubPref', 'sub');
      await loadIframe(false);
      updateWatchHistory(jikanId, title, episode);
    }
  });

  dubOptionBtn.addEventListener('click', async () => {
    if (!dubOptionBtn.classList.contains('active')) {
      dubOptionBtn.classList.add('active');
      subOptionBtn.classList.remove('active');
      localStorage.setItem('animeDubPref', 'dub');
      await loadIframe(true);
      updateWatchHistory(jikanId, title, episode);
    }
  });
});
  </script>
</body>
</html>
